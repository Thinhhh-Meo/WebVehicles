<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/jquery.validate.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validation-unobtrusive/4.0.0/jquery.validate.unobtrusive.min.js"></script>

<script>
    // Custom validation methods
    $.validator.addMethod('filesize', function(value, element, param) {
        // param is the max file size in bytes
        if (element.files.length === 0) return true; // No file selected is valid

        var fileSize = element.files[0].size; // in bytes
        return fileSize <= param;
    });

    $.validator.addMethod('imageformat', function(value, element, param) {
        if (element.files.length === 0) return true;

        var fileName = element.files[0].name;
        var extension = fileName.substr((fileName.lastIndexOf('.') + 1)).toLowerCase();
        var allowedExtensions = param.split(',');

        return allowedExtensions.includes(extension);
    });

    $.validator.addMethod('futureDate', function(value, element) {
        if (!value) return true;

        var selectedDate = new Date(value);
        var today = new Date();
        today.setHours(0, 0, 0, 0);

        return selectedDate >= today;
    });

    $.validator.addMethod('greaterThan', function(value, element, param) {
        var otherValue = $(param).val();
        if (!value || !otherValue) return true;

        return parseFloat(value) > parseFloat(otherValue);
    });

    // Custom unobtrusive adapters
    $.validator.unobtrusive.adapters.add('filesize', ['maxsize'], function(options) {
        options.rules['filesize'] = parseInt(options.params.maxsize);
        options.messages['filesize'] = options.message;
    });

    $.validator.unobtrusive.adapters.add('imageformat', ['formats'], function(options) {
        options.rules['imageformat'] = options.params.formats;
        options.messages['imageformat'] = options.message;
    });

    $.validator.unobtrusive.adapters.add('futureDate', [], function(options) {
        options.rules['futureDate'] = true;
        options.messages['futureDate'] = options.message;
    });

    $.validator.unobtrusive.adapters.add('greaterThan', ['other'], function(options) {
        options.rules['greaterThan'] = '#' + options.params.other;
        options.messages['greaterThan'] = options.message;
    });

    // Custom validation messages
    $.extend($.validator.messages, {
        required: "This field is required.",
        remote: "Please fix this field.",
        email: "Please enter a valid email address.",
        url: "Please enter a valid URL.",
        date: "Please enter a valid date.",
        dateISO: "Please enter a valid date (ISO).",
        number: "Please enter a valid number.",
        digits: "Please enter only digits.",
        equalTo: "Please enter the same value again.",
        maxlength: $.validator.format("Please enter no more than {0} characters."),
        minlength: $.validator.format("Please enter at least {0} characters."),
        rangelength: $.validator.format("Please enter a value between {0} and {1} characters long."),
        range: $.validator.format("Please enter a value between {0} and {1}."),
        max: $.validator.format("Please enter a value less than or equal to {0}."),
        min: $.validator.format("Please enter a value greater than or equal to {0}."),
        filesize: "File size must be less than {0}.",
        imageformat: "Please upload a valid image format ({0}).",
        futureDate: "Date must be today or in the future.",
        greaterThan: "Value must be greater than the other field."
    });

    // Custom validation styling
    $(document).ready(function() {
        // Add Bootstrap styling to validation errors
        $.validator.setDefaults({
            errorElement: 'div',
            errorClass: 'invalid-feedback',
            highlight: function(element, errorClass, validClass) {
                $(element).addClass('is-invalid').removeClass('is-valid');

                // Also mark the parent form-group
                $(element).closest('.form-group, .mb-3').addClass('has-error');
            },
            unhighlight: function(element, errorClass, validClass) {
                $(element).removeClass('is-invalid').addClass('is-valid');

                // Also remove error from parent form-group
                $(element).closest('.form-group, .mb-3').removeClass('has-error');
            },
            errorPlacement: function(error, element) {
                if (element.parent('.input-group').length) {
                    error.insertAfter(element.parent());
                } else if (element.hasClass('form-check-input')) {
                    error.insertAfter(element.closest('.form-check'));
                } else {
                    error.insertAfter(element);
                }
            }
        });

        // Initialize validation on all forms
        $('form').each(function() {
            var $form = $(this);
            var validator = $form.validate();

            // Add submit handler for better UX
            $form.submit(function(e) {
                if (!validator.form()) {
                    // Scroll to first error
                    var firstError = $form.find('.is-invalid').first();
                    if (firstError.length) {
                        $('html, body').animate({
                            scrollTop: firstError.offset().top - 100
                        }, 500);
                    }
                }
            });
        });

        // Real-time validation on input
        $('input, select, textarea').on('blur', function() {
            $(this).valid();
        });

        // Clear validation on reset
        $('button[type="reset"]').click(function() {
            var $form = $(this).closest('form');
            $form.validate().resetForm();
            $form.find('.is-invalid, .is-valid').removeClass('is-invalid is-valid');
            $form.find('.has-error').removeClass('has-error');
        });

        // Handle file input validation
        $('input[type="file"]').on('change', function() {
            $(this).valid();
        });

        // Handle date picker validation
        $('input[type="date"]').on('change', function() {
            $(this).valid();
        });

        // Custom validation for discount value based on type
        $('select[id$="DiscountType"]').on('change', function() {
            var discountValueInput = $(this).closest('.row').find('input[id$="DiscountValue"]');
            if (discountValueInput.length) {
                discountValueInput.valid();
            }
        });
    });

    // Helper functions for validation
    function validateFileSize(input, maxSizeMB) {
        if (input.files && input.files[0]) {
            var fileSize = input.files[0].size; // in bytes
            var maxSize = maxSizeMB * 1024 * 1024; // convert MB to bytes

            if (fileSize > maxSize) {
                return `File size must be less than ${maxSizeMB}MB`;
            }
        }
        return true;
    }

    function validateImageDimensions(input, minWidth, minHeight) {
        return new Promise(function(resolve) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    var img = new Image();
                    img.onload = function() {
                        if (img.width < minWidth || img.height < minHeight) {
                            resolve(`Image dimensions must be at least ${minWidth}x${minHeight}px`);
                        } else {
                            resolve(true);
                        }
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(input.files[0]);
            } else {
                resolve(true);
            }
        });
    }

    // Global validation helper
    window.validateForm = function(formId) {
        var $form = $('#' + formId);
        return $form.validate().form();
    };

    window.getFormErrors = function(formId) {
        var $form = $('#' + formId);
        var validator = $form.validate();
        var errors = [];

        $form.find(':input').each(function() {
            if (!validator.element(this)) {
                errors.push({
                    field: $(this).attr('name'),
                    message: validator.errorList.find(e => e.element === this)?.message
                });
            }
        });

        return errors;
    };
</script>

<style>
    /* Validation styles */
    .is-invalid {
        border-color: #dc3545 !important;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right calc(.375em + .1875rem) center;
        background-size: calc(.75em + .375rem) calc(.75em + .375rem);
        padding-right: calc(1.5em + .75rem);
    }

    .is-valid {
        border-color: #28a745 !important;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%2328a745' d='M2.3 6.73L.6 4.53c-.4-1.04.46-1.4 1.1-.8l1.1 1.4 3.4-3.8c.6-.63 1.6-.27 1.2.7l-4 4.6c-.43.5-.8.4-1.1.1z'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right calc(.375em + .1875rem) center;
        background-size: calc(.75em + .375rem) calc(.75em + .375rem);
        padding-right: calc(1.5em + .75rem);
    }

    .invalid-feedback {
        display: block;
        width: 100%;
        margin-top: .25rem;
        font-size: .875em;
        color: #dc3545;
    }

    .valid-feedback {
        display: block;
        width: 100%;
        margin-top: .25rem;
        font-size: .875em;
        color: #28a745;
    }

    .has-error .form-label {
        color: #dc3545;
    }

    /* Custom validation icons */
    .input-group .is-invalid,
    .input-group .is-valid {
        z-index: 3;
    }

    /* Style for form check validation */
    .form-check-input.is-invalid ~ .form-check-label,
    .was-validated .form-check-input:invalid ~ .form-check-label {
        color: #dc3545;
    }

    .form-check-input.is-valid ~ .form-check-label,
    .was-validated .form-check-input:valid ~ .form-check-label {
        color: #28a745;
    }
</style>