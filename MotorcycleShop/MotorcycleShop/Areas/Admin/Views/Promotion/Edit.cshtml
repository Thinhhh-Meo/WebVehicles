@model MotorcycleShop.Areas.Admin.ViewModels.PromotionEditViewModel
@{
    ViewData["Title"] = "Edit Promotion";
    ViewData["Controller"] = "Promotion";
    ViewData["Action"] = "Edit";
}

<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-12">
            <h1 class="h3 mb-0"><i class="fas fa-edit me-2"></i>@ViewData["Title"]</h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a asp-action="Index">Promotions</a></li>
                    <li class="breadcrumb-item active">Edit Promotion #@Model.PromotionId</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <!-- Promotion Form -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-bullhorn me-2"></i>Edit Promotion Details</h5>
                </div>
                <div class="card-body">
                    <form asp-action="Edit" method="post" enctype="multipart/form-data" id="editPromotionForm">
                        @Html.AntiForgeryToken()
                        <input type="hidden" asp-for="PromotionId" />

                        <div class="row">
                            <!-- Condition -->
                            <div class="col-md-12 mb-3">
                                <label asp-for="Condition" class="form-label">Promotion Condition *</label>
                                <input asp-for="Condition" class="form-control" />
                                <span asp-validation-for="Condition" class="text-danger"></span>
                            </div>

                            <!-- Description -->
                            <div class="col-md-12 mb-3">
                                <label asp-for="Description" class="form-label">Detailed Description *</label>
                                <textarea asp-for="Description" class="form-control" rows="4"></textarea>
                                <span asp-validation-for="Description" class="text-danger"></span>
                            </div>

                            <!-- Discount Link -->
                            <div class="col-md-6 mb-3">
                                <label asp-for="DiscountId" class="form-label">Discount (Optional)</label>
                                <select asp-for="DiscountId" class="form-select" asp-items="ViewBag.Discounts">
                                    <option value="">-- No Discount --</option>
                                </select>
                                <span asp-validation-for="DiscountId" class="text-danger"></span>
                            </div>

                            <!-- Display Order -->
                            <div class="col-md-6 mb-3">
                                <label asp-for="DisplayOrder" class="form-label">Display Order</label>
                                <input asp-for="DisplayOrder" class="form-control" type="number" min="0" max="100" />
                                <span asp-validation-for="DisplayOrder" class="text-danger"></span>
                            </div>

                            <!-- Dates -->
                            <div class="col-md-6 mb-3">
                                <label asp-for="StartDate" class="form-label">Start Date *</label>
                                <input asp-for="StartDate" class="form-control" type="date" />
                                <span asp-validation-for="StartDate" class="text-danger"></span>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label asp-for="EndDate" class="form-label">End Date *</label>
                                <input asp-for="EndDate" class="form-control" type="date" />
                                <span asp-validation-for="EndDate" class="text-danger"></span>
                            </div>

                            <!-- Current Image -->
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Current Image</label>
                                @if (!string.IsNullOrEmpty(Model.ImagePath))
                                {
                                    <div class="current-image mb-3">
                                        <img src="@Model.ImagePath" alt="Current promotion image" class="img-thumbnail" style="max-height: 200px;">
                                        <div class="form-text">
                                            <a href="@Model.ImagePath" target="_blank" class="small me-3"><i class="fas fa-external-link-alt me-1"></i>View Full Size</a>
                                            <a href="#" class="small text-danger" id="removeImageBtn"><i class="fas fa-trash me-1"></i>Remove Image</a>
                                        </div>
                                    </div>
                                    <input type="hidden" id="currentImagePath" value="@Model.ImagePath" />
                                }
                                else
                                {
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i>No image currently set for this promotion
                                    </div>
                                }
                            </div>

                            <!-- New Image Upload -->
                            <div class="col-md-12 mb-3">
                                <label asp-for="ImageFile" class="form-label">Upload New Image (Optional)</label>
                                <div class="image-upload-container">
                                    <div class="image-preview mb-3" id="imagePreview">
                                        <div class="image-placeholder">
                                            <i class="fas fa-image fa-3x text-muted"></i>
                                            <p class="mt-2">Click to select new image</p>
                                        </div>
                                    </div>
                                    <input asp-for="ImageFile" type="file" class="form-control" accept="image/*" id="imageUpload" />
                                    <small class="form-text text-muted">Leave empty to keep current image. Recommended size: 1200x400px</small>
                                </div>
                            </div>

                            <!-- Status -->
                            <div class="col-md-12 mb-4">
                                <div class="form-check form-switch">
                                    <input asp-for="IsActive" class="form-check-input" type="checkbox" role="switch" id="isActiveSwitch">
                                    <label class="form-check-label" for="isActiveSwitch">
                                        <strong>Active Promotion</strong>
                                    </label>
                                </div>
                                <small class="form-text text-muted">Promotion will be visible to customers when active</small>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <a asp-action="Index" class="btn btn-outline-secondary me-2">
                                    <i class="fas fa-arrow-left me-2"></i>Cancel
                                </a>
                                <button type="button" class="btn btn-outline-danger me-2" id="deleteBtn">
                                    <i class="fas fa-trash me-2"></i>Delete
                                </button>
                            </div>
                            <div>
                                <button type="button" class="btn btn-outline-warning me-2" id="previewBtn">
                                    <i class="fas fa-eye me-2"></i>Preview
                                </button>
                                <button type="submit" class="btn btn-primary" id="submitBtn">
                                    <i class="fas fa-save me-2"></i>Save Changes
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <!-- Promotion Status -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Promotion Status</h5>
                </div>
                <div class="card-body">
                    @{
                        var now = DateTime.Now;
                        var status = "";
                        var badgeClass = "";
                        var icon = "";

                        if (!Model.IsActive)
                        {
                            status = "Inactive";
                            badgeClass = "bg-danger";
                            icon = "fas fa-toggle-off";
                        }
                        else if (Model.EndDate < now)
                        {
                            status = "Expired";
                            badgeClass = "bg-secondary";
                            icon = "fas fa-calendar-times";
                        }
                        else if (Model.StartDate > now)
                        {
                            status = "Upcoming";
                            badgeClass = "bg-warning";
                            icon = "fas fa-clock";
                        }
                        else
                        {
                            status = "Active";
                            badgeClass = "bg-success";
                            icon = "fas fa-check-circle";
                        }
                    }

                    <div class="text-center mb-4">
                        <span class="badge @badgeClass py-2 px-3 mb-3" style="font-size: 1rem;">
                            <i class="@icon me-2"></i>@status
                        </span>

                        <div class="progress mb-2" style="height: 8px;">
                            @{
                                var totalDays = (Model.EndDate - Model.StartDate).TotalDays;
                                var elapsedDays = (now - Model.StartDate).TotalDays;
                                var progress = Math.Min(Math.Max(elapsedDays / totalDays * 100, 0), 100);
                            }
                            <div class="progress-bar @(status == "Expired" ? "bg-secondary" : "bg-success")"
                                 role="progressbar"
                                 style="width: @progress%"
                                 aria-valuenow="@progress"
                                 aria-valuemin="0"
                                 aria-valuemax="100">
                            </div>
                        </div>
                        <small class="text-muted">
                            @if (status == "Expired")
                            {
                                <span>Promotion ended on @Model.EndDate.ToString("MMM dd, yyyy")</span>
                            }
                            else if (status == "Upcoming")
                            {
                                <span>Starts in @((Model.StartDate - now).Days) days</span>
                            }
                            else if (status == "Active")
                            {
                                <span>Ends in @((Model.EndDate - now).Days) days</span>
                            }
                        </small>
                    </div>

                    <div class="promotion-stats">
                        <div class="row text-center">
                            <div class="col-6 border-end">
                                <div class="display-6">@Model.DisplayOrder</div>
                                <small class="text-muted">Display Order</small>
                            </div>
                            <div class="col-6">
                                <div class="display-6">@(Model.DiscountId.HasValue ? "Yes" : "No")</div>
                                <small class="text-muted">Has Discount</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-bolt me-2"></i>Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-outline-primary" id="duplicateBtn">
                            <i class="fas fa-copy me-2"></i>Duplicate Promotion
                        </button>
                        <button type="button" class="btn btn-outline-info" id="viewOnSiteBtn">
                            <i class="fas fa-external-link-alt me-2"></i>View on Website
                        </button>
                        <button type="button" class="btn btn-outline-secondary" id="viewHistoryBtn">
                            <i class="fas fa-history me-2"></i>View Edit History
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        .current-image {
            text-align: center;
        }

            .current-image img {
                max-width: 100%;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            }

        .image-upload-container {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background: #f8f9fa;
            transition: all 0.3s;
        }

            .image-upload-container:hover {
                border-color: var(--primary-color);
                background: #f0f2f5;
            }

        .image-preview {
            min-height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-placeholder {
            color: #6c757d;
        }

        #imagePreview img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 6px;
        }

        .promotion-stats .display-6 {
            font-size: 2.5rem;
            font-weight: 300;
            line-height: 1.2;
        }
    </style>
}

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        $(document).ready(function() {
            // Image preview for new upload
            $('#imageUpload').change(function() {
                const file = this.files[0];
                if (file) {
                    const reader = new FileReader();

                    reader.onload = function(e) {
                        $('#imagePreview').html(`<img src="${e.target.result}" alt="Preview" class="img-fluid rounded">`);
                    }

                    reader.readAsDataURL(file);
                } else {
                    $('#imagePreview').html(`
                        <div class="image-placeholder">
                            <i class="fas fa-image fa-3x text-muted"></i>
                            <p class="mt-2">Click to select new image</p>
                        </div>
                    `);
                }
            });

            // Remove current image
            $('#removeImageBtn').click(function(e) {
                e.preventDefault();

                Swal.fire({
                    title: 'Remove Image?',
                    text: 'Are you sure you want to remove the current promotion image?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, Remove It',
                    cancelButtonText: 'Cancel'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $('.current-image').remove();
                        $('#currentImagePath').remove();
                        $('.current-image-section').html(`
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>Image removed. Upload new image or promotion will have no image.
                            </div>
                        `);
                    }
                });
            });

            // Form submission
            $('#editPromotionForm').submit(function(e) {
                // Validate dates
                const startDate = new Date($('#StartDate').val());
                const endDate = new Date($('#EndDate').val());

                if (startDate > endDate) {
                    e.preventDefault();
                    Swal.fire('Error', 'End date must be after start date', 'error');
                    return false;
                }

                // Show loading
                $('#submitBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Saving...');
            });

            // Delete button
            $('#deleteBtn').click(function() {
                Swal.fire({
                    title: 'Delete Promotion?',
                    text: 'Are you sure you want to delete this promotion? This action cannot be undone.',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Yes, Delete It',
                    cancelButtonText: 'Cancel',
                    showLoaderOnConfirm: true,
                    preConfirm: () => {
                        return $.ajax({
                            url: '@Url.Action("Delete", new { id = Model.PromotionId })',
                            type: 'POST',
                            headers: {
                                'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                            }
                        }).then(response => {
                            if (!response.success) {
                                throw new Error(response.message || 'Delete failed');
                            }
                            return response;
                        });
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        Swal.fire({
                            title: 'Deleted!',
                            text: 'Promotion has been deleted successfully.',
                            icon: 'success',
                            confirmButtonText: 'OK'
                        }).then(() => {
                            window.location.href = '@Url.Action("Index")';
                        });
                    }
                });
            });

            // Duplicate button
            $('#duplicateBtn').click(function() {
                Swal.fire({
                    title: 'Duplicate Promotion',
                    text: 'Create a copy of this promotion with new dates?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, Duplicate',
                    cancelButtonText: 'Cancel',
                    input: 'text',
                    inputLabel: 'New Promotion Name',
                    inputPlaceholder: 'Enter name for duplicated promotion',
                    inputValue: '@Model.Condition (Copy)',
                    showLoaderOnConfirm: true,
                    preConfirm: (newName) => {
                        if (!newName) {
                            Swal.showValidationMessage('Please enter a name for the duplicated promotion');
                            return false;
                        }

                        return $.ajax({
                            url: '@Url.Action("Duplicate", new { id = Model.PromotionId })',
                            type: 'POST',
                            data: { newName: newName },
                            headers: {
                                'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                            }
                        }).then(response => {
                            if (!response.success) {
                                throw new Error(response.message || 'Duplication failed');
                            }
                            return response;
                        });
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        Swal.fire({
                            title: 'Duplicated!',
                            text: 'Promotion has been duplicated successfully.',
                            icon: 'success',
                            confirmButtonText: 'View New Promotion'
                        }).then(() => {
                            window.location.href = '@Url.Action("Edit", new { id = "" })' + result.value.newId;
                        });
                    }
                });
            });

            // View on site button
            $('#viewOnSiteBtn').click(function() {
                window.open('/promotions', '_blank');
            });

            // View history button
            $('#viewHistoryBtn').click(function() {
                Swal.fire({
                    title: 'Edit History',
                    html: '<p class="text-muted">Edit history feature would be implemented here.</p>',
                    icon: 'info',
                    confirmButtonText: 'OK'
                });
            });

            // Preview button
            $('#previewBtn').click(function() {
                Swal.fire({
                    title: 'Promotion Preview',
                    html: `
                        <div class="promotion-preview">
                            <div class="preview-image mb-3">
                                ${$('#currentImagePath').length ?
                                    `<img src="${$('#currentImagePath').val()}" class="img-fluid rounded">` :
                                    '<div class="bg-light rounded text-center py-4"><i class="fas fa-image fa-2x text-muted"></i></div>'
                                }
                            </div>
                            <h5>${$('#Condition').val()}</h5>
                            <p class="text-muted">${$('#Description').val()}</p>
                            <div class="bg-light p-3 rounded">
                                <div class="row">
                                    <div class="col-6">
                                        <small>Start Date:</small>
                                        <div class="fw-bold">${$('#StartDate').val()}</div>
                                    </div>
                                    <div class="col-6">
                                        <small>End Date:</small>
                                        <div class="fw-bold">${$('#EndDate').val()}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `,
                    width: 600,
                    showCloseButton: true,
                    showConfirmButton: false
                });
            });

            // Set minimum date for end date based on start date
            $('#StartDate').change(function() {
                const startDate = new Date($(this).val());
                const minEndDate = new Date(startDate);
                minEndDate.setDate(minEndDate.getDate() + 1);

                $('#EndDate').attr('min', minEndDate.toISOString().split('T')[0]);
            });

            // Initialize date constraints
            $('#StartDate').trigger('change');
        });
    </script>
}